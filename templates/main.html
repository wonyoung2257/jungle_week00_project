<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- fontawesome -->
    <script
      src="https://kit.fontawesome.com/def66b134a.js"
      crossorigin="anonymous"
    ></script>

    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>정글 워들</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              clifford: "#da373d",
            },
          },
        },
      };
    </script>
    <style type="text/tailwindcss">
      @layer utilities {
        .content-auto {
          content-visibility: auto;
        }
      }
    </style>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
      integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
      integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
      crossorigin="anonymous"
    ></script>
    <!-- 구글폰트 -->
    <link
      href="https://fonts.googleapis.com/css?family=Stylish&display=swap"
      rel="stylesheet"
    />
    <link href="/static/css/reset.css" rel="stylesheet" />
    <link href="/static/css/main.css" rel="stylesheet" />
    <script>
      function success(id) {
        $.ajax({
          type: "POST",
          url: "/success",
          data: { id: id },
          success: function (response) {
            if (response["result"] == "success") {
              $("#myModal_success").show();
            }
          },
        });
      }

      function fail(id) {
        $.ajax({
          type: "POST",
          url: "/fail",
          data: { id: id },
          success: function (response) {
            if (response["result"] == "success") {
              $("#myModal_fail").show();
            }
          },
        });
      }
    </script>
  </head>
  <body>
    <div class="wrapper">
      <!-- <div class="text-center bg-gray-50 text-blue-800 py-0 px-6">
        
        <h1 class="text-3xl font-bold mt-0 mb-6">Jungle Wordle</h1>
      </div> -->
      <h3 class="font-medium leading-tight text-4xl text-center">
        ㅈㅓㅇㄱㅡㄹ ㅇㅜㅓㄷㅡㄹ
      </h3>
      <h5 class="font-medium leading-tight text-2xl text-center">
        ㅈㅓㅇㄱㅡㄹ ㅇㅜㅓㄷㅡㄹ
      </h5>
      <h6 class="font-medium leading-tight text-base text-center">
        ㅈㅓㅇㄱㅡㄹ ㅇㅜㅓㄷㅡㄹ
      </h6>
      <div class="flex">
        <div class="game grow-[2] flex-auto">
          <h2 class="game_header text-2xl font-bold">
            이름을 맞추세요!!(성 제외)
          </h2>
          <div class="game_input_container"></div>
        </div>
        <div class="ranking grow-[1] flex-auto list-none" id="ranking">
          <div class="flex flex-col">
            <div class="overflow-x-auto sm:-mx-6 lg:-mx-8">
              <div class="py-2 inline-block min-w-full sm:px-6 lg:px-8">
                <div class="overflow-hidden">
                  <section class="mb-20 text-gray-700" style="width: 500px">
                    <div class="text-center md:max-w-xl lg:max-w-3xl mx-auto">
                      <h3 class="text-3xl font-bold mb-6 text-gray-800">
                        명예의 전당
                      </h3>
                    </div>

                    <div
                      class="grid md:grid-cols-3 gap-6 lg:gap-12 text-center"
                    >
                      {% for rank in ranking %} {% if loop.index == 1 %}
                      <div class="mb-12 md:mb-0">
                        <div class="flex justify-center mb-6">
                          <img
                            src="https://cdn-icons-png.flaticon.com/512/2583/2583381.png"
                            class="rounded-full shadow-lg w-32"
                          />
                        </div>
                        <h5 class="text-xl font-semibold mb-4">
                          {{ rank.id }}
                        </h5>
                        <h6 class="font-semibold text-blue-600 mb-4"></h6>
                        <p class="mb-4">
                          성공 - {{ rank.cnt_success }} <br />
                          실패 - {{ rank.cnt_fail }} <br />
                          성공률 - {{ rank.cnt_rate }}%
                        </p>
                      </div>
                      {% elif loop.index == 2 %}
                      <div class="mb-12 md:mb-0">
                        <div class="flex justify-center mb-6">
                          <img
                            src="https://cdn-icons-png.flaticon.com/512/2583/2583350.png"
                            class="rounded-full shadow-lg w-32"
                          />
                        </div>
                        <h5 class="text-xl font-semibold mb-4">
                          {{ rank.id }}
                        </h5>
                        <h6 class="font-semibold text-blue-600 mb-4"></h6>
                        <p class="mb-4">
                          성공 - {{ rank.cnt_success }} <br />
                          실패 - {{ rank.cnt_fail }} <br />
                          성공률 - {{ rank.cnt_rate }}%
                        </p>
                      </div>
                      {% elif loop.index == 3 %}
                      <div class="mb-12 md:mb-0">
                        <div class="flex justify-center mb-6">
                          <img
                            src="https://cdn-icons-png.flaticon.com/512/2583/2583448.png"
                            class="rounded-full shadow-lg w-32"
                          />
                        </div>
                        <h5 class="text-xl font-semibold mb-4">
                          {{ rank.id }}
                        </h5>
                        <h6 class="font-semibold text-blue-600 mb-4"></h6>
                        <p class="mb-4">
                          성공 - {{ rank.cnt_success }} <br />
                          실패 - {{ rank.cnt_fail }} <br />
                          성공률 - {{ rank.cnt_rate }}%
                        </p>
                      </div>
                      {% endif %} {% endfor %}
                    </div>
                  </section>

                  <div class="flex flex-col">
                    <div class="overflow-x-auto sm:-mx-6 lg:-mx-8">
                      <div class="py-2 inline-block min-w-full sm:px-6 lg:px-8">
                        <div class="overflow-hidden">
                          <table class="min-w-full">
                            <thead class="bg-white border-b">
                              <tr>
                                <th
                                  scope="col"
                                  class="text-sm font-medium text-gray-900 px-6 py-4 text-left"
                                >
                                  #
                                </th>
                                <th
                                  scope="col"
                                  class="text-sm font-medium text-gray-900 px-6 py-4 text-left"
                                >
                                  이름
                                </th>
                                <th
                                  scope="col"
                                  class="text-sm font-medium text-gray-900 px-6 py-4 text-left"
                                >
                                  성공
                                </th>
                                <th
                                  scope="col"
                                  class="text-sm font-medium text-gray-900 px-6 py-4 text-left"
                                >
                                  실패
                                </th>
                                <th
                                  scope="col"
                                  class="text-sm font-medium text-gray-900 px-6 py-4 text-left"
                                >
                                  성공률
                                </th>
                              </tr>
                            </thead>
                            <tbody>
                              {% for rank in ranking %} {% if loop.index > 3 %}
                              <tr class="bg-gray-100 border-b">
                                <td
                                  class="text-sm text-gray-900 font-light px-6 py-4 whitespace-nowrap"
                                >
                                  {{loop.index}}
                                </td>
                                <td
                                  class="text-sm text-gray-900 font-light px-6 py-4 whitespace-nowrap"
                                >
                                  {{rank.id}}
                                </td>
                                <td
                                  class="text-sm text-gray-900 font-light px-6 py-4 whitespace-nowrap"
                                >
                                  {{rank.cnt_success}}
                                </td>
                                <td
                                  class="text-sm text-gray-900 font-light px-6 py-4 whitespace-nowrap"
                                >
                                  {{rank.cnt_fail}}
                                </td>
                                <td
                                  class="text-sm text-gray-900 font-light px-6 py-4 whitespace-nowrap"
                                >
                                  {{rank.cnt_rate}}%
                                </td>
                              </tr>
                              {% endif %} {% endfor %}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- The Modal -->
          <div id="myModal_success" class="modal">
            <!-- Modal content -->
            <div class="modal-content">
              <p style="text-align: center">
                <span style="font-size: 14pt"
                  ><b><span style="font-size: 24pt">성공입니다.</span></b></span
                >
              </p>
              <p style="text-align: center; line-height: 1.5">
                <img id="success_img" src="" alt="" />
                <br />
                <span id="suc-egg" class="font-weight-bold text-lg-center"
                  >정답은 <span id="success_span">허원영</span>입니다.</span
                >
                <br />
              </p>
              <p><br /></p>

              <button
                class="pop_bt btn-success rounded h-8"
                onclick="window.location.reload()"
              >
                닫기
              </button>
            </div>
          </div>
          <!--End Modal-->

          <!-- The Modal -->
          <div id="myModal_fail" class="modal">
            <!-- Modal content -->
            <div class="modal-content">
              <p style="text-align: center">
                <span style="font-size: 14pt"
                  ><b><span style="font-size: 24pt">실패입니다.</span></b></span
                >
              </p>
              <p style="text-align: center; line-height: 1.5">
                <img
                  id="fail_img"
                  src="https://ca.slack-edge.com/T01FZU4LB4Y-U038SKTUC4D-2195b3bed407-512"
                  alt=""
                />
                <br />
                <span id="egg" class="font-weight-bold text-lg-center"
                  >정답은 <span id="fail_span">허원영</span>입니다.</span
                >
                <br />
              </p>
              <button
                class="pop_bt btn-success rounded h-8"
                onclick="window.location.reload()"
              >
                닫기
              </button>
            </div>
          </div>
          <!--End Modal-->
        </div>

        <script>
          //DB에서 이름, 사진, 문제 받아옴
          let data = JSON.parse(`{{ answers | safe }}`);
          // 로컬 스토리지에 값이 없다면 입력

          if (localStorage.getItem("answer") === null) {
            localStorage.setItem("answer", data.answer);
            localStorage.setItem("img", data.img);
            localStorage.setItem("name", data.name);
          }
          if (localStorage.getItem("guesses") === null) {
            localStorage.setItem("guesses", JSON.stringify([]));
          }

          let answer = localStorage.getItem("answer");

          // input 창 focus 이동 함수
          const onKeyDownMoveEvent = (e) => {
            const input_el = e.target;
            if (e.keyCode === 8) {
              if (
                input_el.value.length !== input_el.maxLength &&
                input_el.previousSibling
              ) {
                console.log(input_el.previousSibling);
                input_el.previousSibling.focus();
              }
              return;
            }

            if (input_el.value.trim() !== "" && input_el.nextSibling) {
              let first_word = getConstantVowel(input_el.value.trim());
              if (first_word) {
                input_el.value = first_word;
              }
              input_el.nextSibling.focus();
            }
          };
          // 자음 모음 분리
          function getConstantVowel(kor) {
            const f = [
              "ㄱ",
              "ㄲ",
              "ㄴ",
              "ㄷ",
              "ㄸ",
              "ㄹ",
              "ㅁ",
              "ㅂ",
              "ㅃ",
              "ㅅ",
              "ㅆ",
              "ㅇ",
              "ㅈ",
              "ㅉ",
              "ㅊ",
              "ㅋ",
              "ㅌ",
              "ㅍ",
              "ㅎ",
            ];
            const s = [
              "ㅏ",
              "ㅐ",
              "ㅑ",
              "ㅒ",
              "ㅓ",
              "ㅔ",
              "ㅕ",
              "ㅖ",
              "ㅗ",
              "ㅘ",
              "ㅙ",
              "ㅚ",
              "ㅛ",
              "ㅜ",
              "ㅝ",
              "ㅞ",
              "ㅟ",
              "ㅠ",
              "ㅡ",
              "ㅢ",
              "ㅣ",
            ];
            const t = [
              "",
              "ㄱ",
              "ㄲ",
              "ㄳ",
              "ㄴ",
              "ㄵ",
              "ㄶ",
              "ㄷ",
              "ㄹ",
              "ㄺ",
              "ㄻ",
              "ㄼ",
              "ㄽ",
              "ㄾ",
              "ㄿ",
              "ㅀ",
              "ㅁ",
              "ㅂ",
              "ㅄ",
              "ㅅ",
              "ㅆ",
              "ㅇ",
              "ㅈ",
              "ㅊ",
              "ㅋ",
              "ㅌ",
              "ㅍ",
              "ㅎ",
            ];

            const ga = 44032;
            let uni = kor.charCodeAt(0);

            uni = uni - ga;

            let fn = parseInt(uni / 588);
            let sn = parseInt((uni - fn * 588) / 28);
            let tn = parseInt(uni % 28);

            if (f[fn] === undefined) {
              return null;
            } else return f[fn];
          }

          //정답 값에 따라 박스 생성 함수
          const create_game_input = (answer) => {
            let $game_input_container = document.querySelector(
              ".game_input_container"
            );
            for (let i = 0; i < 6; i++) {
              let input_id = `input_wrap_${i}`;
              let template = `<div id="${input_id}" class="input_wrapper">`;
              $game_input_container.innerHTML += template;
              let $input_id = document.querySelector(`#${input_id}`);
              if (i == 0) {
                for (let j = 0; j < answer.length; j++) {
                  $input_id.innerHTML += `<input type="text" class="game_input" maxlength="1" onkeyup ='onKeyDownMoveEvent(event)'/>`;
                }
              } else {
                for (let j = 0; j < answer.length; j++) {
                  $input_id.innerHTML += `<input type="text" class="game_input" maxlength="1" disabled onkeyup ='onKeyDownMoveEvent(event)'/>`;
                }
              }
            }
          };

          create_game_input(answer);

          // 사용자가 입력한 guesses가 있다면 input창에 넣어서 활성화 시킨다.
          const fill_input = (guesses) => {
            let game_input = document.querySelector(
              ".game_input_container"
            ).children;
            console.log(game_input[0].children[0].value);

            // console.log(
            //   document.querySelector(`#${game_input}`).children[0].value
            // );
            guesses.map((user_input, index) => {
              user_input = user_input.split(",");
              let green = [];
              console.log(green);
              let yellow = [];
              let gray = [];
              let temp_answer = answer.split("");
              console.log(temp_answer);
              console.log(user_input);
              // 게임 로직
              for (let i = 0; i < answer.length; i++) {
                console.log(user_input[i]);
                if (user_input[i] === answer[i]) {
                  temp_answer[i] = "";
                  green.push(i);
                }
                game_input[index].children[i].value.readOnly = true;
              }
              for (let i = 0; i < answer.length; i++) {
                if (temp_answer.includes(user_input[i]) && !green.includes(i)) {
                  temp_answer[temp_answer.indexOf(user_input[i])] = "";
                  yellow.push(i);
                } else if (!green.includes(i) && !yellow.includes(i)) {
                  gray.push(i);
                }
                game_input[index].children[i].readOnly = true;
              }
              for (let i = 0; i < user_input.length; i++) {
                if (index + 1 < 6) {
                  game_input[index + 1].children[i].disabled = false;
                }
              }

              green.map((i) => {
                game_input[index].children[i].value = user_input[i];
                game_input[index].children[i].style.backgroundColor = "#22C55E";
                game_input[index].children[i].style.color = "white";
              });
              yellow.map((i) => {
                game_input[index].children[i].value = user_input[i];
                game_input[index].children[i].style.backgroundColor = "#EAB308";
                game_input[index].children[i].style.color = "white";
              });
              gray.map((i) => {
                game_input[index].children[i].value = user_input[i];
                game_input[index].children[i].style.backgroundColor = "#94A3B8";
                game_input[index].children[i].style.color = "white";
              });
            });
          };

          fill_input(JSON.parse(localStorage.getItem("guesses")));
          //input의 정답값이 맞는지 확인하는 함수
          const check_answer = (select) => {
            // 사용자 input값 받아 오기
            let user_input = document.querySelector(`#${select}`).children;
            let next_input = null;
            // 사용자가 입력한 input의 다음 input값을 가져온다.
            // 비활성화 되어 있는 input의 값을 활성화 시키기 위한 코드
            if (document.querySelector(`#${select}`).nextSibling != null) {
              next_input = document.querySelector(`#${select}`).nextSibling
                .childNodes;
            }

            // input 값 입력하지 않은 칸이 있는지 검사하기
            for (let i = 0; i < user_input.length; i++) {
              if (user_input[i].value.trim() === "") {
                alert("빈칸을 채워주세요");
                return;
              }
            }
            //localStorage guesses 배열에 사용자 입력저장
            let guesses = [];
            for (let i = 0; i < user_input.length; i++) {
              guesses.push(user_input[i].value);
            }
            if (guesses.length > 0) {
              let temp = JSON.parse(localStorage.getItem("guesses"));
              temp.push(guesses.join());
              localStorage.setItem("guesses", JSON.stringify(temp));
            }

            // 다음 input 칸이 있다면 활성화
            if (next_input !== null) {
              for (let i = 0; i < next_input.length; i++) {
                next_input[i].disabled = false;
              }
            }

            // input 창 정답 검사 로직 칸에 색칠함
            let green = [];
            let yellow = [];
            let gray = [];
            let temp_answer = answer.split("");
            // 게임 로직
            for (let i = 0; i < answer.length; i++) {
              if (user_input[i].value === answer[i]) {
                temp_answer[i] = "";
                green.push(i);
              }
              user_input[i].readOnly = true;
            }
            for (let i = 0; i < answer.length; i++) {
              if (
                temp_answer.includes(user_input[i].value) &&
                !green.includes(i)
              ) {
                temp_answer[temp_answer.indexOf(user_input[i].value)] = "";
                yellow.push(i);
              } else if (!green.includes(i) && !yellow.includes(i)) {
                gray.push(i);
              }
              user_input[i].readOnly = true;
            }

            green.map((i) => {
              user_input[i].style.backgroundColor = "#22C55E";
              user_input[i].style.color = "white";
            });
            yellow.map((i) => {
              user_input[i].style.backgroundColor = "#EAB308";
              user_input[i].style.color = "white";
            });
            gray.map((i) => {
              user_input[i].style.backgroundColor = "#94A3B8";
              user_input[i].style.color = "white";
            });
            if (select !== "input_wrap_5") {
              next_input[0].focus();
            }

            //성공 실패 판별
            let user_id = localStorage.getItem("userID");
            if (green.length == answer.length) {
              localStorage.removeItem("answer");
              localStorage.removeItem("guesses");

              document.querySelector("#success_img").src =
                localStorage.getItem("img");
              document.querySelector("#success_span").innerHTML =
                localStorage.getItem("name");

              if (localStorage.getItem("name") == "장병규")
                document.querySelector("#suc-egg").innerHTML =
                  "정답은 장병규입니다. 의장님도 B반의 일원입니다. ";
              if (localStorage.getItem("name") == "류석영")
                document.querySelector("#suc-egg").innerHTML =
                  "정답은 류석영입니다. 교수님도 B반의 일원입니다. ";
              if (localStorage.getItem("name") == "정주원")
                document.querySelector("#suc-egg").innerHTML =
                  "정답은 정주원입니다. 코치님도 B반의 일원입니다. ";
              if (localStorage.getItem("name") == "이범규")
                document.querySelector("#suc-egg").innerHTML =
                  "정답은 이범규입니다. 대표님도 B반의 일원입니다. ";
              if (localStorage.getItem("name") == "윤혁")
                document.querySelector("#suc-egg").innerHTML =
                  "정답은 윤혁입니다. 외자여서 성까지 했습니다.. ";

              success(user_id);

              return;
            }

            if (select === "input_wrap_5") {
              localStorage.removeItem("answer");
              localStorage.removeItem("guesses");

              document.querySelector("#fail_img").src =
                localStorage.getItem("img");
              document.querySelector("#fail_span").innerHTML =
                localStorage.getItem("name");

              if (localStorage.getItem("name") == "장병규")
                document.querySelector("#egg").innerHTML =
                  "정답은 장병규입니다. 의장님도 B반의 일원입니다. ";
              if (localStorage.getItem("name") == "류석영")
                document.querySelector("#egg").innerHTML =
                  "정답은 류석영입니다. 교수님도 B반의 일원입니다. ";
              if (localStorage.getItem("name") == "정주원")
                document.querySelector("#egg").innerHTML =
                  "정답은 정주원입니다. 코치님도 B반의 일원입니다. ";
              if (localStorage.getItem("name") == "이범규")
                document.querySelector("#egg").innerHTML =
                  "정답은 이범규입니다. 대표님도 B반의 일원입니다. ";
              if (localStorage.getItem("name") == "윤혁")
                document.querySelector("#egg").innerHTML =
                  "정답은 윤혁입니다. 외자여서 성까지 했습니다.. ";

              fail(user_id);
              return;
            }
          };

          //game_inputs에 이벤트 위함 엔터키 이벤트 발생
          let game_inputs = document.querySelector(".game_input_container");
          game_inputs.addEventListener("keypress", (e) => {
            if (e.key == "Enter") {
              check_answer(e.target.parentNode.id);
            }
          });
        </script>
      </div>
    </div>
  </body>
</html>
