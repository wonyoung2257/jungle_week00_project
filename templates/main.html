<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- fontawesome -->
    <script
      src="https://kit.fontawesome.com/def66b134a.js"
      crossorigin="anonymous"
    ></script>

    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>정글 워들</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              clifford: "#da373d",
            },
          },
        },
      };
    </script>
    <style type="text/tailwindcss">
      @layer utilities {
        .content-auto {
          content-visibility: auto;
        }
      }
    </style>

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous"
    />

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
      integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
      integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
      crossorigin="anonymous"
    ></script>
    <!-- 구글폰트 -->
    <link
      href="https://fonts.googleapis.com/css?family=Stylish&display=swap"
      rel="stylesheet"
    />
    <link href="/static/css/reset.css" rel="stylesheet" />
    <link href="/static/css/main.css" rel="stylesheet" />
    <script>
      function success(id) {
        $.ajax({
          type: "POST",
          url: "/success",
          data: { id: id },
          success: function (response) {
            if (response["result"] == "success") {
              $("#myModal_success").show();
            }
          },
        });
      }

      function fail(id) {
        $.ajax({
          type: "POST",
          url: "/fail",
          data: { id: id },
          success: function (response) {
            if (response["result"] == "success") {
              $("#myModal_fail").show();
            }
          },
        });
      }
    </script>
  </head>
  <body>
    <div class="wrapper">
      <header class="header text-xl grow font-bold">Jungle Wordle</header>
      <div class="main_wrapper">
        <div class="ranking list-none" id="ranking">
          <div class="flex flex-col">
            <div class="overflow-x-auto sm:-mx-6 lg:-mx-8">
              <div class="py-2 inline-block min-w-full sm:px-6 lg:px-8">
                <div class="overflow-hidden">
                  JUNGLE WORDLE 명예의 전당
                  <table
                    class="min-w-full"
                    style="width: 100%; border: 1px solid #444444"
                  >
                    <thead class="border-b">
                      <tr>
                        <th
                          scope="col"
                          class="text-sm font-medium text-gray-900 px-6 py-4 text-left"
                        >
                          #
                        </th>
                        <th
                          scope="col"
                          class="text-sm font-medium text-gray-900 px-6 py-4 text-left"
                        >
                          이름
                        </th>
                        <th
                          scope="col"
                          class="text-sm font-medium text-gray-900 px-6 py-4 text-left"
                        >
                          성공
                        </th>
                        <th
                          scope="col"
                          class="text-sm font-medium text-gray-900 px-6 py-4 text-left"
                        >
                          실패
                        </th>
                        <th
                          scope="col"
                          class="text-sm font-medium text-gray-900 px-6 py-4 text-left"
                        >
                          성공율
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for rank in ranking %}
                      <tr class="border-b">
                        <td
                          class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900"
                        >
                          {% if loop.index == 1 %}
                          <img
                            src="https://cdn-icons-png.flaticon.com/512/2583/2583381.png"
                            style="
                              width: 30px;
                              height: 30px;
                              max-width: 100%;
                              top: 10px;
                              position: relative;
                              right: 9px;
                            "
                          />
                          {% elif loop.index == 2 %}
                          <img
                            src="https://cdn-icons-png.flaticon.com/512/2583/2583350.png"
                            style="
                              width: 30px;
                              height: 30px;
                              max-width: 100%;
                              top: 10px;
                              position: relative;
                              right: 9px;
                            "
                          />
                          {% elif loop.index == 3 %}
                          <img
                            src="https://cdn-icons-png.flaticon.com/512/2583/2583448.png"
                            style="
                              width: 30px;
                              height: 30px;
                              max-width: 100%;
                              top: 10px;
                              position: relative;
                              right: 9px;
                            "
                          />
                          {% else %} {{loop.index}} {% endif %}
                        </td>
                        <td
                          class="text-sm text-gray-900 font-light px-6 py-4 whitespace-nowrap"
                        >
                          {{ rank.id }}
                        </td>
                        <td
                          class="text-sm text-gray-900 font-light px-6 py-4 whitespace-nowrap"
                        >
                          {{ rank.cnt_success }}
                        </td>
                        <td
                          class="text-sm text-gray-900 font-light px-6 py-4 whitespace-nowrap"
                        >
                          {{ rank.cnt_fail }}
                        </td>
                        <td
                          class="text-sm text-gray-900 font-light px-6 py-4 whitespace-nowrap"
                        >
                          {{ rank.cnt_rate}} %
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- The Modal -->
          <div id="myModal_success" class="modal">
            <!-- Modal content -->
            <div class="modal-content">
              <p style="text-align: center">
                <span style="font-size: 14pt"
                  ><b><span style="font-size: 24pt">성공입니다.</span></b></span
                >
              </p>
              <p style="text-align: center; line-height: 1.5">
                <img id="success_img" src="" alt="" />
                <br />
                <span class="font-weight-bold text-lg-center"
                  >정답은 <span id="success_span">허원영</span>입니다.</span
                >
                <br />
              </p>
              <p><br /></p>

              <button
                class="pop_bt btn-success rounded h-8"
                onclick="window.location.reload()"
              >
                닫기
              </button>
            </div>
          </div>
          <!--End Modal-->

          <!-- The Modal -->
          <div id="myModal_fail" class="modal">
            <!-- Modal content -->
            <div class="modal-content">
              <p style="text-align: center">
                <span style="font-size: 14pt"
                  ><b><span style="font-size: 24pt">실패입니다.</span></b></span
                >
              </p>
              <p style="text-align: center; line-height: 1.5">
                <img
                  id="fail_img"
                  src="https://ca.slack-edge.com/T01FZU4LB4Y-U038SKTUC4D-2195b3bed407-512"
                  alt=""
                />
                <br />
                <span class="font-weight-bold text-lg-center"
                  >정답은 <span id="fail_span">허원영</span>입니다.</span
                >
                <br />
              </p>
              <button
                class="pop_bt btn-success rounded h-8"
                onclick="window.location.reload()"
              >
                닫기
              </button>
            </div>
          </div>
          <!--End Modal-->
        </div>

        <div class="game">
          <h2 class="game_header text-xl font-bold">이름을 맞추세요!!</h2>
          <div class="game_input_container"></div>
        </div>
        <script>
          let data = JSON.parse(`{{ answers | safe }}`);
          let answer = data.answer;
          //모달 창 화면 설정
          document.querySelector("#success_img").src = data.img;
          document.querySelector("#fail_img").src = data.img;
          document.querySelector("#success_span").innerHTML = data.name;
          document.querySelector("#fail_span").innerHTML = data.name;
          //

          // input 창 focus 이동 함수
          const onKeyDownMoveEvent = (e) => {
            const input_el = e.target;
            if (e.keyCode === 8) {
              if (
                input_el.value.length !== input_el.maxLength &&
                input_el.previousSibling
              ) {
                input_el.previousSibling.focus();
              }
              return;
            }

            if (input_el.value.trim() !== "" && input_el.nextSibling) {
              let first_word = getConstantVowel(input_el.value.trim());
              console.log(first_word);
              if (first_word) {
                input_el.value = first_word;
              }
              input_el.nextSibling.focus();
            }
          };
          // 자음 모음 분리
          function getConstantVowel(kor) {
            const f = [
              "ㄱ",
              "ㄲ",
              "ㄴ",
              "ㄷ",
              "ㄸ",
              "ㄹ",
              "ㅁ",
              "ㅂ",
              "ㅃ",
              "ㅅ",
              "ㅆ",
              "ㅇ",
              "ㅈ",
              "ㅉ",
              "ㅊ",
              "ㅋ",
              "ㅌ",
              "ㅍ",
              "ㅎ",
            ];
            const s = [
              "ㅏ",
              "ㅐ",
              "ㅑ",
              "ㅒ",
              "ㅓ",
              "ㅔ",
              "ㅕ",
              "ㅖ",
              "ㅗ",
              "ㅘ",
              "ㅙ",
              "ㅚ",
              "ㅛ",
              "ㅜ",
              "ㅝ",
              "ㅞ",
              "ㅟ",
              "ㅠ",
              "ㅡ",
              "ㅢ",
              "ㅣ",
            ];
            const t = [
              "",
              "ㄱ",
              "ㄲ",
              "ㄳ",
              "ㄴ",
              "ㄵ",
              "ㄶ",
              "ㄷ",
              "ㄹ",
              "ㄺ",
              "ㄻ",
              "ㄼ",
              "ㄽ",
              "ㄾ",
              "ㄿ",
              "ㅀ",
              "ㅁ",
              "ㅂ",
              "ㅄ",
              "ㅅ",
              "ㅆ",
              "ㅇ",
              "ㅈ",
              "ㅊ",
              "ㅋ",
              "ㅌ",
              "ㅍ",
              "ㅎ",
            ];

            const ga = 44032;
            let uni = kor.charCodeAt(0);

            uni = uni - ga;

            let fn = parseInt(uni / 588);
            let sn = parseInt((uni - fn * 588) / 28);
            let tn = parseInt(uni % 28);

            if (f[fn] === undefined) {
              return null;
            } else return f[fn];
          }

          //정답 값에 따라 박스 생성 함수
          const create_game_input = (answer) => {
            let $game_input_container = document.querySelector(
              ".game_input_container"
            );
            for (let i = 0; i < 6; i++) {
              let input_id = `input_wrap_${i}`;
              let template = `<div id="${input_id}" class="input_wrapper">`;
              $game_input_container.innerHTML += template;
              let $input_id = document.querySelector(`#${input_id}`);
              if (i == 0) {
                for (let j = 0; j < answer.length; j++) {
                  $input_id.innerHTML += `<input type="text" class="game_input" maxlength="1" onkeyup ='onKeyDownMoveEvent(event)'/>`;
                }
              } else {
                for (let j = 0; j < answer.length; j++) {
                  $input_id.innerHTML += `<input type="text" class="game_input" maxlength="1" disabled onkeyup ='onKeyDownMoveEvent(event)'/>`;
                }
              }
            }
          };

          create_game_input(answer);

          //input의 정답값이 맞는지 확인하는 함수
          const check_answer = (select) => {
            // 사용자 input값 받아 오기
            let user_input = document.querySelector(`#${select}`).children;
            let next_input = null;
            if (document.querySelector(`#${select}`).nextSibling != null) {
              next_input = document.querySelector(`#${select}`).nextSibling
                .childNodes;
            }

            // input 값 유효성 검사하기
            for (let i = 0; i < user_input.length; i++) {
              if (user_input[i].value.trim() === "") {
                alert("빈칸을 채워주세요");
                return;
              }
            }
            if (next_input !== null) {
              for (let i = 0; i < next_input.length; i++) {
                next_input[i].disabled = false;
              }
            }

            let green = [];
            let yellow = [];
            let gray = [];
            let temp_answer = answer.split("");
            // 게임 로직
            for (let i = 0; i < answer.length; i++) {
              if (user_input[i].value === answer[i]) {
                temp_answer[i] = "";
                green.push(i);
              }
              user_input[i].readOnly = true;
            }
            for (let i = 0; i < answer.length; i++) {
              if (
                temp_answer.includes(user_input[i].value) &&
                !green.includes(i)
              ) {
                temp_answer[temp_answer.indexOf(user_input[i].value)] = "";
                yellow.push(i);
              } else if (!green.includes(i) && !yellow.includes(i)) {
                gray.push(i);
              }
              user_input[i].readOnly = true;
            }

            green.map((i) => {
              user_input[i].style.backgroundColor = "#22C55E";
              user_input[i].style.color = "white";
            });
            yellow.map((i) => {
              user_input[i].style.backgroundColor = "#EAB308";
              user_input[i].style.color = "white";
            });
            gray.map((i) => {
              user_input[i].style.backgroundColor = "#94A3B8";
              user_input[i].style.color = "white";
            });
            let user_id = localStorage.getItem("userID");

            //성공 실패 판별
            if (green.length == answer.length) {
              success(user_id);
              return;
            }

            if (select === "input_wrap_5") {
              fail(user_id);
              return;
            }
          };

          //game_inputs에 이벤트 위함 엔터키 이벤트 발생
          let game_inputs = document.querySelector(".game_input_container");
          game_inputs.addEventListener("keypress", (e) => {
            if (e.key == "Enter") {
              check_answer(e.target.parentNode.id);
            }
          });
        </script>
      </div>
    </div>
  </body>
</html>
